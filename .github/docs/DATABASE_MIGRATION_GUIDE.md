# Database Migration Guide - Smart Queue

## ðŸ“‹ Overview

This guide will help you apply the database schema changes for the Smart Queue feature.

**Migration File**: `drizzle/0003_chemical_mastermind.sql`

---

## ðŸš€ Quick Migration (Recommended)

### Option 1: Using Drizzle Kit (Easiest)

```bash
# Make sure your database is running
# and DATABASE_URL is set in .env

npm run db:push
```

This will:

- âœ… Read your schema from `src/server/db/schema.ts`
- âœ… Compare with current database state
- âœ… Apply all necessary changes
- âœ… Create tables and columns automatically

### Option 2: Manual SQL Execution

If `db:push` doesn't work:

```bash
# Connect to your PostgreSQL database
psql -U your_username -d your_database_name

# Run the migration file
\i drizzle/0003_chemical_mastermind.sql

# Or copy-paste the SQL directly
```

---

## ðŸ“Š What Gets Created

### New Tables (2)

#### 1. `recommendation_cache`

Stores cached recommendations from Deezer API to reduce API calls.

```sql
CREATE TABLE hexmusic-stream_recommendation_cache (
  id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  seed_track_id BIGINT NOT NULL,
  recommended_track_ids JSONB NOT NULL,
  recommended_tracks_data JSONB NOT NULL,
  source VARCHAR(50) DEFAULT 'deezer' NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL
);
```

**Indexes:**

- `rec_cache_seed_idx` on `seed_track_id`
- `rec_cache_expires_idx` on `expires_at`
- `rec_cache_source_idx` on `source`

#### 2. `audio_features`

Stores audio analysis data from Essentia (feature flagged, for future use).

```sql
CREATE TABLE hexmusic-stream_audio_features (
  id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  track_id BIGINT NOT NULL UNIQUE,
  bpm REAL,
  key VARCHAR(10),
  energy REAL,
  danceability REAL,
  valence REAL,
  acousticness REAL,
  instrumentalness REAL,
  liveness REAL,
  speechiness REAL,
  loudness REAL,
  spectral_centroid REAL,
  analyzed_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
  source VARCHAR(50) DEFAULT 'essentia'
);
```

**Indexes:**

- `audio_features_track_idx` on `track_id`
- `audio_features_bpm_idx` on `bpm`
- `audio_features_energy_idx` on `energy`
- `audio_features_key_idx` on `key`

### Updated Tables (1)

#### `user_preferences` - 5 New Columns

```sql
ALTER TABLE hexmusic-stream_user_preferences
ADD COLUMN auto_queue_enabled BOOLEAN DEFAULT FALSE NOT NULL,
ADD COLUMN auto_queue_threshold INTEGER DEFAULT 3 NOT NULL,
ADD COLUMN auto_queue_count INTEGER DEFAULT 5 NOT NULL,
ADD COLUMN smart_mix_enabled BOOLEAN DEFAULT TRUE NOT NULL,
ADD COLUMN similarity_preference VARCHAR(20) DEFAULT 'balanced';
```

---

## âœ… Verification Steps

After running the migration, verify everything worked:

### 1. Check Tables Exist

```sql
-- Connect to your database
psql -U your_username -d your_database_name

-- List all tables (should see the new ones)
\dt hexmusic-stream*

-- Should show:
-- hexmusic-stream_recommendation_cache
-- hexmusic-stream_audio_features
-- (and all existing tables)
```

### 2. Check Columns Added

```sql
-- Verify user_preferences has new columns
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'hexmusic-stream_user_preferences'
  AND column_name IN (
    'auto_queue_enabled',
    'auto_queue_threshold',
    'auto_queue_count',
    'smart_mix_enabled',
    'similarity_preference'
  );
```

Should return 5 rows.

### 3. Check Indexes Created

```sql
-- Verify indexes exist
SELECT indexname
FROM pg_indexes
WHERE tablename LIKE 'hexmusic-stream_%'
  AND indexname LIKE '%rec_cache%'
  OR indexname LIKE '%audio_features%';
```

Should return 7 indexes:

- 3 for `recommendation_cache`
- 4 for `audio_features`

### 4. Test Insert

```sql
-- Test recommendation_cache table
INSERT INTO "hexmusic-stream_recommendation_cache" (
  seed_track_id,
  recommended_track_ids,
  recommended_tracks_data,
  expires_at
) VALUES (
  3135556,
  '[]'::jsonb,
  '[]'::jsonb,
  NOW() + INTERVAL '24 hours'
);

-- Should succeed without errors

-- Clean up test
DELETE FROM "hexmusic-stream_recommendation_cache" WHERE seed_track_id = 3135556;
```

---

## ðŸ› Troubleshooting

### Error: Database "t3app" does not exist

**Problem**: Wrong database name in `.env`

**Solution**:

```bash
# Check your .env file
cat .env | grep DATABASE_URL

# Should be something like:
# DATABASE_URL="postgresql://user:password@localhost:5432/your_actual_db_name"
```

### Error: Permission denied

**Problem**: Database user doesn't have CREATE TABLE permissions

**Solution**:

```sql
-- Grant necessary permissions
GRANT CREATE ON DATABASE your_database TO your_user;
GRANT ALL ON SCHEMA public TO your_user;
```

### Error: Table already exists

**Problem**: Migration was run before (not actually an error!)

**Solution**: Tables are already created, you're good to go!

```sql
-- Verify tables exist
\dt hexmusic-stream_recommendation_cache
\dt hexmusic-stream_audio_features
```

### Error: Column already exists

**Problem**: Columns were added manually or migration ran partially

**Solution**: Check which columns exist:

```sql
SELECT column_name
FROM information_schema.columns
WHERE table_name = 'hexmusic-stream_user_preferences'
  AND column_name LIKE 'auto_queue%'
  OR column_name LIKE 'smart_mix%'
  OR column_name = 'similarity_preference';
```

If all 5 columns exist, you're done!

---

## ðŸ”„ Rollback (If Needed)

### To Undo the Migration

```sql
-- Drop new tables
DROP TABLE IF EXISTS "hexmusic-stream_recommendation_cache" CASCADE;
DROP TABLE IF EXISTS "hexmusic-stream_audio_features" CASCADE;

-- Remove new columns from user_preferences
ALTER TABLE "hexmusic-stream_user_preferences"
DROP COLUMN IF EXISTS auto_queue_enabled,
DROP COLUMN IF EXISTS auto_queue_threshold,
DROP COLUMN IF EXISTS auto_queue_count,
DROP COLUMN IF EXISTS smart_mix_enabled,
DROP COLUMN IF EXISTS similarity_preference;
```

---

## ðŸ“Š Database Size Impact

### Estimated Storage Requirements

- **Empty Tables**: ~100KB
- **Per User**: ~1KB for preferences
- **Per Cached Recommendation**: ~2KB
- **Per Audio Feature**: ~500 bytes

### Example: 1000 Users, 10000 Cached Tracks

- User preferences: 1000 Ã— 1KB = 1MB
- Recommendation cache: 10000 Ã— 2KB = 20MB
- Audio features: 10000 Ã— 500B = 5MB
- **Total**: ~26MB additional storage

---

## ðŸŽ¯ Next Steps

After successful migration:

1. **Restart Development Server**

   ```bash
   npm run dev
   ```

2. **Test Smart Queue Features**
   - Open queue panel
   - Enable auto-queue
   - Try adding similar tracks

3. **Monitor Database**

   ```sql
   -- Watch cache grow
   SELECT COUNT(*) FROM "hexmusic-stream_recommendation_cache";

   -- Check cache expiry
   SELECT COUNT(*) FROM "hexmusic-stream_recommendation_cache"
   WHERE expires_at > NOW();
   ```

4. **Set Up Cache Cleanup (Optional)**

   ```sql
   -- Create a daily cleanup job (PostgreSQL)
   CREATE OR REPLACE FUNCTION cleanup_expired_cache()
   RETURNS void AS $$
   BEGIN
     DELETE FROM "hexmusic-stream_recommendation_cache"
     WHERE expires_at < NOW();
   END;
   $$ LANGUAGE plpgsql;

   -- Schedule it (requires pg_cron extension)
   SELECT cron.schedule(
     'cleanup-recommendations',
     '0 3 * * *',  -- 3 AM daily
     $$SELECT cleanup_expired_cache();$$
   );
   ```

---

## ðŸ“ Manual Migration SQL (Copy-Paste)

If you need to run the SQL manually, here's the complete script:

```sql
-- Start transaction
BEGIN;

-- Create recommendation_cache table
CREATE TABLE IF NOT EXISTS "hexmusic-stream_recommendation_cache" (
  "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "seed_track_id" BIGINT NOT NULL,
  "recommended_track_ids" JSONB NOT NULL,
  "recommended_tracks_data" JSONB NOT NULL,
  "source" VARCHAR(50) DEFAULT 'deezer' NOT NULL,
  "created_at" TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
  "expires_at" TIMESTAMP WITH TIME ZONE NOT NULL
);

CREATE INDEX IF NOT EXISTS "rec_cache_seed_idx" ON "hexmusic-stream_recommendation_cache" ("seed_track_id");
CREATE INDEX IF NOT EXISTS "rec_cache_expires_idx" ON "hexmusic-stream_recommendation_cache" ("expires_at");
CREATE INDEX IF NOT EXISTS "rec_cache_source_idx" ON "hexmusic-stream_recommendation_cache" ("source");

-- Create audio_features table
CREATE TABLE IF NOT EXISTS "hexmusic-stream_audio_features" (
  "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "track_id" BIGINT NOT NULL UNIQUE,
  "bpm" REAL,
  "key" VARCHAR(10),
  "energy" REAL,
  "danceability" REAL,
  "valence" REAL,
  "acousticness" REAL,
  "instrumentalness" REAL,
  "liveness" REAL,
  "speechiness" REAL,
  "loudness" REAL,
  "spectral_centroid" REAL,
  "analyzed_at" TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
  "source" VARCHAR(50) DEFAULT 'essentia'
);

CREATE INDEX IF NOT EXISTS "audio_features_track_idx" ON "hexmusic-stream_audio_features" ("track_id");
CREATE INDEX IF NOT EXISTS "audio_features_bpm_idx" ON "hexmusic-stream_audio_features" ("bpm");
CREATE INDEX IF NOT EXISTS "audio_features_energy_idx" ON "hexmusic-stream_audio_features" ("energy");
CREATE INDEX IF NOT EXISTS "audio_features_key_idx" ON "hexmusic-stream_audio_features" ("key");

-- Add columns to user_preferences
ALTER TABLE "hexmusic-stream_user_preferences"
ADD COLUMN IF NOT EXISTS "auto_queue_enabled" BOOLEAN DEFAULT FALSE NOT NULL,
ADD COLUMN IF NOT EXISTS "auto_queue_threshold" INTEGER DEFAULT 3 NOT NULL,
ADD COLUMN IF NOT EXISTS "auto_queue_count" INTEGER DEFAULT 5 NOT NULL,
ADD COLUMN IF NOT EXISTS "smart_mix_enabled" BOOLEAN DEFAULT TRUE NOT NULL,
ADD COLUMN IF NOT EXISTS "similarity_preference" VARCHAR(20) DEFAULT 'balanced';

-- Commit transaction
COMMIT;
```

---

## âœ… Success Checklist

- [ ] Database migration completed without errors
- [ ] All 3 tables exist (2 new + 1 updated)
- [ ] All 7 indexes created
- [ ] All 5 columns added to `user_preferences`
- [ ] Test insert works
- [ ] Development server restarted
- [ ] Smart queue features work in UI
